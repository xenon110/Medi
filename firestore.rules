
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Patients can only read/write their own data.
    match /patients/{patientId} {
      allow read, write: if request.auth != null && request.auth.uid == patientId;
    }

    // Doctors can only read/write their own data.
    // Doctors can read patient data ONLY IF they are linked in a consultation (to be added later).
    match /doctors/{doctorId} {
      allow read, write: if request.auth != null && request.auth.uid == doctorId;
    }
    
    // Reports can be read by the patient who owns it or the doctor assigned to it.
    // Patients can create reports.
    match /reports/{reportId} {
      allow create: if request.auth != null; // Anyone authenticated can create a report
      allow read: if request.auth != null && (resource.data.patientId == request.auth.uid || resource.data.doctorId == request.auth.uid);
      allow update: if request.auth != null && resource.data.doctorId == request.auth.uid; // Only doctors can update
    }

    // Chats are private between a patient and a doctor.
    match /chats/{chatId} {
      allow read, write: if request.auth != null && (request.auth.uid in resource.data.participants);
    }
  }
}
