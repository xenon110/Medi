rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Doctors collection
    match /doctors/{doctorId} {
      allow read: if request.auth != null && 
                  (resource.data.verificationStatus == "approved" || request.auth.uid == doctorId);
      allow write: if request.auth != null && request.auth.uid == doctorId;
    }

    // Patients collection
    match /patients/{patientId} {
      allow read, write: if request.auth != null && request.auth.uid == patientId;
    }

    // Reports collection
    match /reports/{reportId} {
      
      // Patients can create a report for themselves
      allow create: if request.auth != null &&
                    request.resource.data.patientId == request.auth.uid;

      // Reading a single report
      allow get: if request.auth != null &&
                        (resource.data.patientId == request.auth.uid ||
                         resource.data.doctorId == request.auth.uid);

      // Updating a report
      allow update: if request.auth != null &&
                    (
                      // Doctor can update a report assigned to them
                      resource.data.doctorId == request.auth.uid || 
                      // Patient can update a report (e.g. to send to a doctor)
                      (resource.data.patientId == request.auth.uid && request.resource.data.doctorId != null)
                    );

      // Listing reports securely using queries
      allow list: if request.auth != null &&
                  (
                    // Patient can list only their reports
                    (request.query.where('patientId', '==', request.auth.uid)) ||
                    // Doctor can list only reports assigned to them
                    (request.query.where('doctorId', '==', request.auth.uid))
                  );
    }

    // Emergencies collection
    match /emergencies/{emergencyId} {
      allow create: if request.auth != null;
    }
  }
}
